<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prebid with Dailymotion</title>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://geo.dailymotion.com/libs/player/x1hs9.js"></script>
    <script src="https://cdn.api.getjad.io/prebid/120157152"></script>
    <script src="https://c.amazon-adsystem.com/aax2/apstag.js"></script>

    <script id="toText">
        var pageConfig = {
            dataLayer: {
                key1: ["value1", "value2"],
                key2: ["value1"]
            },
            iu: "/120157152/PUREPEOPLE_FR_WEB/article/vertical"
        }

        var videoHbConfig = {
            failsafeTimeout: 4000,
            prebid: {
                code: 'video1',
                mediaTypes: {
                    video: {
                        context: 'instream',
                        playerSize: [640, 480],
                        mimes: ['video/mp4'],
                        protocols: [1, 2, 3, 4, 5, 6, 7, 8],
                        playbackmethod: [2],
                        skip: 1
                    }
                },
                bids: [{
                    bidder: 'appnexus',
                    params: {
                        placementId: 19482691

                    }
                }]
            },
            amazon: [{
                slotID: 'preroll_playertop',
                mediaType: 'video',
                sizes: [
                    [640, 390]
                ]
            }]
        }

        // Video request manager
        var videoRequestManager = {
            playerCreated: false,
            amazon: {
                bidRecieved: false,
                custParams: "",
            },
            prebid: {
                bidRecieved: false,
                custParams: "",
            }
        };

        function fromDataLayerToEncodedCustParams(dataLayer) {
            var keyvalues = []
            for (const [key, values] of Object.entries(dataLayer)) {
                keyvalues.push(key + "=" + values.join(","))
            }
            return encodeURIComponent(keyvalues.join("&"))
        }

        // Prebid from callback to custParams
        function prebidCallbackToCustParams(callback) {
            var custParams = decodeURIComponent(callback.split("cust_params=")[1])
            return encodeURIComponent(custParams);
        }

        // Amazon from callback to custParams
        function attachVideoTargeting(bids) {
            let targeting = bids.filter(function(bid) {
                    return bid.mediaType === 'video'
                })
                .map(function(bid) {
                    return bid.helpers.encodedQsParams()
                })
                .join('');
            return targeting
        };

        function fromHbCallbackToAdsParams(hbCallback) {
            var toJoin = []
            toJoin.push(fromDataLayerToEncodedCustParams(pageConfig.dataLayer));
            if (hbCallback.length > 1) toJoin.push(hbCallback.join(""));

            custParams = toJoin.join(encodeURIComponent("&"));

            toJoin = [];
            toJoin.push(pageConfig.iu);
            toJoin.push(custParams);
            return toJoin.join("/");
        }

        // Init prebid
        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        pbjs.que.push(function() {
            pbjs.setConfig({
                cache: {
                    url: 'https://prebid.adnxs.com/pbc/v1/cache'
                }
            });
        });

        // Init amazon
        window.apstag = window.apstag || {
            init: function() {
                apstag._Q.push(["i", arguments, (new Date).getTime()])
            },
            fetchBids: function() {
                apstag._Q.push(["f", arguments, (new Date).getTime()])
            },
            setDisplayBids: function() {},
            _Q: []
        };

        apstag.init({
            pubID: 3309,
            deals: true
        });

        // Initiate promise - this is what will decide when the player can be created (i.e. when prebid bid response are recieved)
        var videoHeaderBiddingIsFinished, videoHeaderBiddingHasFailed;

        var videoHeaderBiddingPromise = new Promise((resolve, reject) => {
            videoHeaderBiddingIsFinished = resolve
            videoHeaderBiddingHasFailed = reject
        });

        // Let's prebid 
        pbjs.que.push(function() {
            pbjs.addAdUnits(videoHbConfig.prebid);

            pbjs.requestBids({
                bidsBackHandler: function(bids) {
                    var vastUrl = pbjs.adServers.dfp.buildVideoUrl({
                        adUnit: videoHbConfig.prebid,
                        params: {
                            output: 'vast'
                        }
                    })

                    videoRequestManager.prebid.custParams = prebidCallbackToCustParams(vastUrl);
                    videoRequestManager.prebid.bidRecieved = true

                    if (videoRequestManager.prebid.bidRecieved && videoRequestManager.amazon.bidRecieved) {
                        videoHeaderBiddingIsFinished([videoRequestManager.prebid.custParams, videoRequestManager.amazon.custParams]);
                    }
                    // the bid callback resolves the promise with a VAST url made by prebid
                    // JWPlayer works fine with a VAST url but Dailymotion require a specifically structured and encoded "adsParams"   
                }
            });
        });

        // Let's amazon
        apstag.fetchBids({
                slots: videoHbConfig.amazon,
                timeout: 3000
            },
            function(bids) {

                videoRequestManager.amazon.custParams = attachVideoTargeting(bids);
                videoRequestManager.amazon.bidRecieved = true

                if (videoRequestManager.prebid.bidRecieved && videoRequestManager.amazon.bidRecieved) {
                    videoHeaderBiddingIsFinished([videoRequestManager.prebid.custParams, videoRequestManager.amazon.custParams]);
                }

            }
        );

        // Failsafe !
        setTimeout(function() {
            if (!videoRequestManager.playerCreated) {
                videoHeaderBiddingHasFailed([videoRequestManager.prebid.custParams, videoRequestManager.amazon.custParams]);
            }
        }, videoHbConfig.failsafeTimeout);

        // What to do when prebid is finished (i.e. the promise is resolved)
        videoHeaderBiddingPromise
            .then((hbCallback) => {
                createDailymotionPlayerWithAd(fromHbCallbackToAdsParams(hbCallback));
                videoRequestManager.playerCreated = true
                console.log("success >> dm triggered on hb finished")
            })
            .catch((hbCallback) => {
                createDailymotionPlayerWithAd(fromHbCallbackToAdsParams(hbCallback));
                videoRequestManager.playerCreated = true
                console.log("fail >> dm triggered on timeout")
            })

        // Create a Dailymotion player with ads from adsParams
        function createDailymotionPlayerWithAd(adsParams) {
            dailymotion.createPlayer("player", {
                video: "x84fxvq",
                params: {
                    adsConfig: {
                        adsParams: adsParams,
                    },
                }
            });
        }
    </script>

    <link rel="stylesheet" href="css/style.css">
</head>

<body style="height:100vh;">

    <nav>
        <a href="index.html" class="href">
            <div class="logo"><span class="tools">üß∞</span></div>
        </a>
        <div><a href="demos.html">‚Üê Back to demos</a></div>
    </nav>

    <h1 style="padding: 20px;">Demo - Video header bidding with prebid and amazon</h1>

    <section style="display:flex !important; flex-direction: row !important">
        <div style="width:480px; padding:20px;">
            <div id="player"></div>
            <div id="buttons">
                <button id="playWithDaily">Play with Dailymotion</button>
                <button id="playWithJW">Play with JWPlayer</button>
            </div>
        </div>
        <pre style="margin-top:20px" class="prettyprint"></pre>
    </section>

    <script>
        document.querySelector("pre").innerHTML = document.querySelector("script#toText").innerHTML
    </script>

    <style>
        #buttons {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
        }
        
        button {
            border: none;
            padding: 5px;
            background-color: #E3E3E3;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>

</body>

</html>